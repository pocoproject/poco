//
// ArchiveStrategy.h
//
// $Id: //poco/Main/Data/include/Poco/ArchiveStrategy.h#1 $
//
// Library: Data
// Package: Logging
// Module:  ArchiveStrategy
//
// Definition of the ArchiveStrategy class and subclasses.
//
// Copyright (c) 2004-2006, Applied Informatics Software Engineering GmbH.
// and Contributors.
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.
//


#ifndef Data_ArchiveStrategy_INCLUDED
#define Data_ArchiveStrategy_INCLUDED


#include "Poco/Data/Data.h"
#include "Poco/Data/Session.h"
#include "Poco/DateTime.h"
#include "Poco/Timespan.h"
#include "Poco/Dynamic/Var.h"
#include "Poco/SharedPtr.h"


namespace Poco {
namespace Data {


class Data_API ArchiveStrategy
	/// The ArchiveStrategy is used by SQLChannel to archive log rows.
{
public:
	static const std::string DEFAULT_ARCHIVE_DESTINATION;

	ArchiveStrategy(const std::string& connector, 
		const std::string& connect, 
		const std::string& source, 
		const std::string& destination = DEFAULT_ARCHIVE_DESTINATION);
		/// Creates archive strategy.

	virtual ~ArchiveStrategy();
		/// Destroys archive strategy.

	void open();
		/// Opens the session.

	virtual void archive() = 0;
		/// Archives the rows.

	const std::string& getSource() const;
		/// Returns the name of the source table containing rows to be archived.

	void setSource(const std::string& source);
		/// Sets the name of the source table.

	const std::string& getDestination() const;
		/// Returns the name of the destination table for rows to be archived.

	void setDestination(const std::string& destination);
		/// Sets the name of the destination table.

	virtual const std::string& getThreshold() const = 0;
		/// Returns the archive threshold.

	virtual void setThreshold(const std::string& threshold) = 0;
		/// Sets the archive threshold.

protected:
	typedef Poco::SharedPtr<Session>   SessionPtr;
	typedef Poco::SharedPtr<Statement> StatementPtr;

	Session& session();

	void setCopyStatement();
	void setDeleteStatement();
	void setCountStatement();

	Statement& getCopyStatement();
	Statement& getDeleteStatement();
	Statement& getCountStatement();
private:
	
	ArchiveStrategy();
	ArchiveStrategy(const ArchiveStrategy&);
	ArchiveStrategy& operator = (const ArchiveStrategy&);

	std::string  _connector;
	std::string  _connect;
	SessionPtr   _pSession;
	StatementPtr _pCopyStatement;
	StatementPtr _pDeleteStatement;
	StatementPtr _pCountStatement;
	std::string  _source;
	std::string  _destination;
};


//
// inlines
//

inline const std::string& ArchiveStrategy::getSource() const
{
	return _source;
}


inline void ArchiveStrategy::setSource(const std::string& source)
{
	_source = source;
}


inline void ArchiveStrategy::setDestination(const std::string& destination)
{
	_destination = destination;
}


inline const std::string& ArchiveStrategy::getDestination() const
{
	return _destination;
}


inline Session& ArchiveStrategy::session()
{
	return *_pSession;
}


inline void ArchiveStrategy::setCopyStatement()
{
	_pCopyStatement = StatementPtr(new Statement(*_pSession));
}


inline void ArchiveStrategy::setDeleteStatement()
{
	_pDeleteStatement = StatementPtr(new Statement(*_pSession));
}


inline void ArchiveStrategy::setCountStatement()
{
	_pCountStatement = StatementPtr(new Statement(*_pSession));
}


inline Statement& ArchiveStrategy::getCopyStatement()
{
	return *_pCopyStatement;
}


inline Statement& ArchiveStrategy::getDeleteStatement()
{
	return *_pDeleteStatement;
}


inline Statement& ArchiveStrategy::getCountStatement()
{
	return *_pCountStatement;
}



//
// ArchiveByAgeStrategy
//
class Data_API ArchiveByAgeStrategy: public ArchiveStrategy
	/// Archives rows scheduled for archiving.
{
public:
	ArchiveByAgeStrategy(const std::string& connector, 
		const std::string& connect, 
		const std::string& sourceTable, 
		const std::string& destinationTable = DEFAULT_ARCHIVE_DESTINATION);
	
	~ArchiveByAgeStrategy();

	void archive();

	const std::string& getThreshold() const;
		/// Returns the archive threshold.

	void setThreshold(const std::string& threshold);
		/// Sets the archive threshold.

private:
	ArchiveByAgeStrategy();
	ArchiveByAgeStrategy(const ArchiveByAgeStrategy&);
	ArchiveByAgeStrategy& operator = (const ArchiveByAgeStrategy&);

	void initStatements();

	Timespan     _maxAge;
	std::string  _ageString;
	DateTime     _archiveDateTime;
	Poco::Dynamic::Var _archiveCount;
};


//
// inlines
//

inline const std::string& ArchiveByAgeStrategy::getThreshold() const
{
	return _ageString;
}


} } // namespace Poco::Data


#endif // Data_ArchiveStrategy_INCLUDED
