version: '{build}'

cache:
    - c:\OpenSSL-Win32
    - c:\OpenSSL-Win64
    - c:\ProgramData\chocolatey

services:
  - mongodb
  
branches:
  only:
  - AppVeyor

# to add several configurations to build matrix:
configuration:
#  - Debug
  - release
#  - static_md
#  - static_mt

environment:
  matrix:
    - builder: 120
      arch_ssl: Win32
      arch_nuget: Win32
      arch_vc: x86
      arch_choco: --x86
      arch_target: x86
      platform: Win32
      linkmode: shared
      suffix:

    - builder: 120
      arch_ssl: Win64
      arch_nuget: x64
      arch_vc: x86_amd64
      arch_choco:
      arch_target: x86_64
      platform: x64
      linkmode: shared
      suffix: 64
      
    - builder: 140
      arch_ssl: Win32
      arch_nuget: Win32
      arch_vc: x86
      arch_choco: --x86
      arch_target: x86
      platform: Win32
      linkmode: shared
      suffix:

    - builder: 140
      arch_ssl: Win64
      arch_nuget: x64
      arch_vc: x86_amd64
      arch_choco:
      arch_target: x86_64
      platform: x64
      suffix: 64
      linkmode: shared
      
    - builder: cmake
      arch_ssl: Win64
      arch_nuget: x64
      arch_vc: amd64
      arch_choco:
      arch_target: x86_64
      
    - builder: cmake
      arch_ssl: Win32
      arch_nuget: Win32
      arch_vc: amd64_x86  # cross-compile from amd64 to x86
      arch_choco: --x86
      arch_target: x86


install:
  - cinst cmake
# - cinst mysql
  - cinst jom
  - systeminfo
  - c:\cygwin\bin\uname -a
  - c:\cygwin\bin\cat /proc/cpuinfo
  - c:\cygwin\bin\cat /proc/meminfo
  - ps: |
        if (Test-Path "c:\OpenSSL-$env:arch_ssl") {
            echo "using openssl from cache"
        } else {
            echo "downloading openssl"
            Invoke-WebRequest "https://slproweb.com/download/$($env:arch_ssl)OpenSSL-1_0_2d.exe" -OutFile c:\openssl-setup.exe
            echo "installing openssl"
            Start-Process -Wait -FilePath c:\openssl-setup.exe -ArgumentList "/silent /verysilent /sp- /suppressmsgboxes"
        }
  - c:\cygwin\bin\find /cygdrive/c/OpenSSL-%arch_ssl% "-type" f
  - ps: |
        if (Test-Path "%ChocolateyInstall%/bin/jom.exe") {
            echo "using jom from cache"
        } else {
            choco install jom
        }

before_build:
  - set
  - call "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\vcvarsall.bat" %arch_vc%
  - set PATH=%ChocolateyInstall%\bin;%PATH%
# chocolatey brokes jom, here's workaround
# see https://github.com/jcfr/qt-easy-build/commit/6366f4275562bdaf4f686838600f46894579c41e)
  - set PATH=%ChocolateyInstall%\lib\jom\content;%PATH%
  - path

build_script:
  - ps: |
      if ($builder -eq "cmake")
      {
         mkdir install
         & .\build_cmake.cmd %Configuration% "-DCMAKE_INSTALL_PREFIX=%CD%\install"
      } else {
          & .\buildwin.cmd %builder% build %linkmode% %Configuration% %platform% samples tests devenv
      }

test_script:
  - ps: |
      if ($builder -eq "cmake") {
      }
      if (($builder -ne "cmake") -and ($linkmode -eq "shared")) {    
         $env:PATH = $env:CD\bin$env:suffix;$env:PATH
         & .\build\script\runtests2 %suffix%
      }
 