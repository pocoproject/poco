version: '{build}'

cache:
    - c:\OpenSSL-Win32
    - c:\OpenSSL-Win64
    - c:\ProgramData\chocolatey

services:
  - mongodb
  
branches:
  only:
  - AppVeyor

# to add several configurations to build matrix:
configuration:
#  - Debug
  - Release

environment:
  matrix:
    - builder: 120
      ssl_arch: Win32
      nuget_arch: Win32
      vc_arch: x86
      choco_arch: --x86
      target_arch: x86
      vs_arch: Win32
      suffix:

    - builder: 120
      ssl_arch: Win64
      nuget_arch: x64
      vc_arch: x86_amd64
      choco_arch:
      target_arch: x86_64
      vs_arch: x64
      suffix: 64
      
    - builder: 140
      ssl_arch: Win32
      nuget_arch: Win32
      vc_arch: x86
      choco_arch: --x86
      target_arch: x86
      vs_arch: Win32
      suffix:

    - builder: 140
      ssl_arch: Win64
      nuget_arch: x64
      vc_arch: x86_amd64
      choco_arch:
      target_arch: x86_64
      vs_arch: x64
      suffix: 64
      
    - builder: cmake
      ssl_arch: Win64
      nuget_arch: x64
      vc_arch: amd64
      choco_arch:
      target_arch: x86_64
      
    - builder: cmake
      ssl_arch: Win32
      nuget_arch: Win32
      vc_arch: amd64_x86  # cross-compile from amd64 to x86
      choco_arch: --x86
      target_arch: x86


install:
  - cinst cmake
# - cinst mysql
  - cinst jom
  - systeminfo
  - c:\cygwin\bin\uname -a
  - c:\cygwin\bin\cat /proc/cpuinfo
  - c:\cygwin\bin\cat /proc/meminfo
  - ps: |
        if (Test-Path "c:\OpenSSL-$env:ssl_arch") {
            echo "using openssl from cache"
        } else {
            echo "downloading openssl"
            Invoke-WebRequest "https://slproweb.com/download/$($env:ssl_arch)OpenSSL-1_0_2d.exe" -OutFile c:\openssl-setup.exe
            echo "installing openssl"
            Start-Process -Wait -FilePath c:\openssl-setup.exe -ArgumentList "/silent /verysilent /sp- /suppressmsgboxes"
        }
  - c:\cygwin\bin\find /cygdrive/c/OpenSSL-%ssl_arch% "-type" f
  - ps: |
        if (Test-Path "%ChocolateyInstall%/bin/jom.exe") {
            echo "using jom from cache"
        } else {
            choco install jom
        }

before_build:
  - set
  - call "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\vcvarsall.bat" %vc_arch%
  - set PATH=%ChocolateyInstall%\bin;%PATH%
# chocolatey brokes jom, here's workaround
# see https://github.com/jcfr/qt-easy-build/commit/6366f4275562bdaf4f686838600f46894579c41e)
  - set PATH=%ChocolateyInstall%\lib\jom\content;%PATH%
  - path

build_script:
  - ps: |
      if ($builder -eq "cmake") {
         mkdir install
         build_cmake.cmd %Configuration% "-DCMAKE_INSTALL_PREFIX=%CD%\install"
      } else {
         buildwin.cmd %builder% build all both %vs_arch% samples tests devenv
      }

test_script:
  - ps: |
      if ($builder -eq "cmake") {
         set PATH=%CD%\install\bin;%PATH%
      } else {
         set PATH=%CD%\bin%suffix%;%PATH%
         build\script\runtests2
      }
 